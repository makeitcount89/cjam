<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProJam - Live Music Collaboration</title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    padding: 20px;
}

.container {
    max-width: 700px;
    width: 100%;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

h1 { font-size: 2.5em; margin-bottom: 10px; text-align: center; }
.subtitle { text-align: center; opacity: 0.9; margin-bottom: 40px; }

.form-group { margin-bottom: 25px; }
label { display:block; margin-bottom:8px; font-weight:500; }

input {
    width:100%;
    padding:15px;
    border:none;
    border-radius:10px;
    font-size:16px;
    background: rgba(255,255,255,0.9);
}

button {
    width:100%;
    padding:15px;
    border:none;
    border-radius:10px;
    font-size:18px;
    font-weight:bold;
    cursor:pointer;
    background: linear-gradient(135deg,#f093fb,#f5576c);
    color:white;
}

.status {
    margin-top:30px;
    padding:20px;
    background: rgba(0,0,0,0.2);
    border-radius:10px;
    display:none;
}

.status.active { display:block; }

.controls-panel {
    background: rgba(255,255,255,0.1);
    border-radius:10px;
    padding:20px;
    margin:20px 0;
}

.control-row {
    display:flex;
    align-items:center;
    gap:15px;
    margin-bottom:15px;
}

input[type="range"] { flex:1; }

.peer {
    padding:10px;
    background: rgba(255,255,255,0.1);
    border-radius:8px;
    margin-bottom:8px;
    display:flex;
    gap:10px;
}

.peer-indicator {
    width:12px;
    height:12px;
    background:#4ade80;
    border-radius:50%;
}

.level-meter {
    width:100%;
    height:40px;
    background: rgba(0,0,0,0.3);
    border-radius:8px;
    margin-top:20px;
    overflow:hidden;
}

.level-bar {
    height:100%;
    background: linear-gradient(90deg,#4ade80,#facc15,#ef4444);
    width:0%;
}
</style>
</head>

<body>
<div class="container">
<h1>ðŸŽ¸ ProJam</h1>
<p class="subtitle">Real-time music collaboration</p>

<div id="joinForm">
    <div class="form-group">
        <label>Room Name</label>
        <input id="roomName" value="jam-room">
    </div>
    <div class="form-group">
        <label>Your Name</label>
        <input id="username">
    </div>
    <button id="joinBtn">Join Jam Session ðŸŽµ</button>
</div>

<div id="status" class="status">
    <h3>Status: <span id="statusText">Connectingâ€¦</span></h3>

    <div class="controls-panel">
        <div class="control-row">
            <span>Self Monitor</span>
            <input type="checkbox" id="monitorCheck">
            <input type="range" id="monitorSlider" min="0" max="100" value="0">
        </div>
    </div>

    <div class="level-meter"><div id="levelBar" class="level-bar"></div></div>
    <p>Buffer: <span id="bufferStats">0ms</span></p>

    <h4>Peers</h4>
    <div id="peerList"></div>

    <button id="leaveBtn" style="margin-top:20px;background:#dc2626;">Leave</button>
</div>
</div>

<script>
/* ================= STATE ================= */
let ws = null;
let audioContext = null;
let localStream = null;
let audioProcessor = null;

let playbackBuffer = [];
let maxBufferFrames = 10;

let monitorEnabled = false;
let monitorGain = 0;
let myPeerId = null;

/* ================= UI ================= */
const joinBtn = document.getElementById('joinBtn');
const leaveBtn = document.getElementById('leaveBtn');
const joinForm = document.getElementById('joinForm');
const status = document.getElementById('status');
const statusText = document.getElementById('statusText');
const peerList = document.getElementById('peerList');
const levelBar = document.getElementById('levelBar');
const bufferStats = document.getElementById('bufferStats');
const monitorCheck = document.getElementById('monitorCheck');
const monitorSlider = document.getElementById('monitorSlider');

monitorCheck.onchange = e => monitorEnabled = e.target.checked;
monitorSlider.oninput = e => monitorGain = e.target.value / 100;

/* ================= JOIN ================= */
joinBtn.onclick = async () => {
    const room = roomName.value.trim();
    const name = username.value.trim();
    if (!room || !name) return alert("Missing fields");

    localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    audioContext = new AudioContext({ sampleRate:48000 });

    startMeter();
    startPlayback();

    ws = new WebSocket(`wss://jam2.swpage89.workers.dev/?room=${room}`);

    ws.onopen = () => {
        ws.send(JSON.stringify({
            type:'join',
            username:name,
            public_ip:'web-client',
            public_port:0
        }));
        joinForm.style.display='none';
        status.classList.add('active');
        statusText.textContent='Connected';
    };

    ws.onmessage = e => {
        if (e.data instanceof ArrayBuffer) {
            queueFrame(e.data);
            return;
        }
        handleSignal(JSON.parse(e.data));
    };
};

/* ================= SIGNALING ================= */
function handleSignal(d){
    if (d.type==='joined'){ myPeerId=d.peerId; setupCapture(); }
    if (d.type==='user-joined') addPeer(d.peerId,d.username);
    if (d.type==='user-left') removePeer(d.peerId);
}

/* ================= AUDIO CAPTURE ================= */
function setupCapture(){
    const source = audioContext.createMediaStreamSource(localStream);
    audioProcessor = audioContext.createScriptProcessor(1024,1,1);

    const frame = new Int16Array(960);
    let idx = 0;

    audioProcessor.onaudioprocess = e => {
        const input = e.inputBuffer.getChannelData(0);
        for (let i=0;i<input.length;i++){
            const s=Math.max(-1,Math.min(1,input[i]));
            frame[idx++] = s<0 ? s*32768 : s*32767;

            if (idx===frame.length){
                if (ws?.readyState===1) ws.send(frame.buffer);

                if (monitorEnabled && monitorGain>0){
                    const m=new Int16Array(frame.length);
                    for (let j=0;j<m.length;j++) m[j]=frame[j]*monitorGain;
                    queueFrame(m.buffer);
                }
                idx=0;
            }
        }
    };

    source.connect(audioProcessor);
    audioProcessor.connect(audioContext.destination);
}

/* ================= PLAYBACK ================= */
function queueFrame(buf){
    playbackBuffer.push(buf);
    while(playbackBuffer.length>maxBufferFrames) playbackBuffer.shift();
    bufferStats.textContent = (playbackBuffer.length*20)+'ms';
}

function startPlayback(){
    let t = audioContext.currentTime;
    setInterval(()=>{
        if (!playbackBuffer.length) return;
        const pcm=new Int16Array(playbackBuffer.shift());
        const f32=new Float32Array(pcm.length);
        for(let i=0;i<pcm.length;i++) f32[i]=pcm[i]/32768;

        const b=audioContext.createBuffer(1,f32.length,48000);
        b.getChannelData(0).set(f32);

        const s=audioContext.createBufferSource();
        s.buffer=b;
        s.connect(audioContext.destination);

        if (t<audioContext.currentTime) t=audioContext.currentTime;
        s.start(t); t+=0.02;
    },10);
}

/* ================= LEVEL METER ================= */
function startMeter(){
    const analyser=audioContext.createAnalyser();
    audioContext.createMediaStreamSource(localStream).connect(analyser);
    const data=new Uint8Array(analyser.frequencyBinCount);
    (function loop(){
        analyser.getByteFrequencyData(data);
        levelBar.style.width=(data.reduce((a,b)=>a+b)/data.length/255*100)+'%';
        requestAnimationFrame(loop);
    })();
}

/* ================= PEERS ================= */
function addPeer(id,name){
    const d=document.createElement('div');
    d.id='peer-'+id;
    d.className='peer';
    d.innerHTML=`<div class="peer-indicator"></div>${name}`;
    peerList.appendChild(d);
}
function removePeer(id){
    document.getElementById('peer-'+id)?.remove();
}

/* ================= LEAVE ================= */
leaveBtn.onclick = ()=>{
    ws?.close();
    audioProcessor?.disconnect();
    audioContext?.close();
    localStream?.getTracks().forEach(t=>t.stop());
    location.reload();
};
</script>
</body>
</html>
